{% extends 'base.html' %}
{% block title %}Authentication{% endblock %}

{% block style %}
{{ super() }}

<!-- Override base.html flash messages for this page -->
<style>
    /* Hide all flash messages on login page - we use JavaScript messages */
    .flash-container {
        display: none !important;
    }
    
    #flash-messages {
        display: none !important;
    }
</style>

<link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
/* Cookie Consent Banner */
.cookie-consent {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
    color: white;
    padding: 20px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
    z-index: 10000;
    display: none;
    animation: slideUp 0.5s ease-out;
}

.cookie-consent.show {
    display: block;
}

.cookie-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    flex-wrap: wrap;
}

.cookie-text {
    flex: 1;
    min-width: 250px;
}

.cookie-text h4 {
    margin: 0 0 8px 0;
    font-size: 18px;
    color: #fff;
}

.cookie-text p {
    margin: 0;
    font-size: 14px;
    color: #d1d5db;
    line-height: 1.5;
}

.cookie-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.cookie-btn {
    padding: 10px 24px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    font-family: 'Poppins', sans-serif;
}

.cookie-btn.accept {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.cookie-btn.accept:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.cookie-btn.decline {
    background: transparent;
    border: 2px solid #4b5563;
    color: #d1d5db;
}

.cookie-btn.decline:hover {
    border-color: #667eea;
    color: white;
}

@media (max-width: 768px) {
    .cookie-content {
        flex-direction: column;
        text-align: center;
    }
    
    .cookie-buttons {
        justify-content: center;
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div class="cookie-content">
        <div class="cookie-text">
            <h4>üç™ We Value Your Privacy</h4>
            <p>We use cookies and session storage to enhance your experience, keep you logged in, and analyze site usage. By clicking "Accept", you consent to our use of cookies.</p>
        </div>
        <div class="cookie-buttons">
            <button class="cookie-btn decline" onclick="declineCookies()">Decline</button>
            <button class="cookie-btn accept" onclick="acceptCookies()">Accept All</button>
        </div>
    </div>
</div>

<!-- Animated Background Particles -->
<div class="bg-particles">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
</div>

<div class="container">
    <!-- Logo Section -->
    <div class="logo-section">
        <div class="logo-icon">
            <img src="{{ url_for('static', filename='images/app_logo.png') }}" alt="AQI Logo" class="logo-image">
        </div>
        <div class="logo-text">AQI Smart Health Advisor</div>
    </div>

    <!-- Hidden input to store redirect parameter -->
    <input type="hidden" id="redirect_to" value="{{ redirect_to }}">

    <div class="form-box">
        <!-- Login Form -->
        <div class="form-container active" id="loginForm">
            <h2>Welcome Back</h2>
            <p class="form-subtitle">Sign in to monitor air quality and stay protected</p>
            
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="input-box">
                    <input id="login-email" name="email" type="email" placeholder="Email Address" required>
                    <i class="fas fa-envelope"></i>
                </div>
                
                <div class="input-box">
                    <input id="login-password" name="password" type="password" placeholder="Password" required>
                    <i class="fas fa-lock"></i>
                </div>
                
                <div class="remember">
                    <label>
                        <input type="checkbox" name="remember">
                        <span>Remember me</span>
                    </label>
                    <a href="#">Forgot password?</a>
                </div>
                
                <button type="submit" class="btn">Login</button>
                
                <div class="create">
                    Don't have an account? <a href="#" onclick="toggleForm(event)">Sign Up</a>
                </div>
                
                <div class="social-login">
                    <div class="divider">
                        <span>Or login with</span>
                    </div>
                    <div class="social-icons">
                        <a href="#" class="fb"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="tw"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="gl"><i class="fab fa-google"></i></a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Signup Form -->
        <div class="form-container" id="signupForm">
            <h2>Create Account</h2>
            <p class="form-subtitle">Join us to start monitoring air quality</p>
            
            <form id="signup-form" onsubmit="handleSignup(event)">
                <div class="input-box">
                    <input id="signup-username" name="username" type="text" placeholder="Full Name" required>
                    <i class="fas fa-user"></i>
                </div>
                
                <div class="input-box">
                    <input id="signup-email" name="email" type="email" placeholder="Email" required>
                    <i class="fas fa-envelope"></i>
                </div>
                
                <div class="input-box">
                    <input id="signup-age" name="age" type="number" placeholder="Age" min="1" max="150" required>
                    <i class="fas fa-calendar-alt"></i>
                </div>
                
                <div class="input-box">
                    <select id="signup-gender" name="gender" required>
                        <option value="" disabled selected>Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                    <i class="fas fa-venus-mars"></i>
                </div>
                
                <div class="input-box">
                    <input type="text" id="signup-city" name="city" placeholder="Enter city" autocomplete="off" required>
                    <i class="fas fa-map-marker-alt"></i>
                    <ul id="suggestions"></ul>
                </div>
                
                <div class="input-box">
                    <input id="signup-password" name="password" type="password" placeholder="Password" minlength="6" required>
                    <i class="fas fa-lock"></i>
                </div>
                
                <div class="input-box">
                    <input id="signup-confirm-password" name="confirm_password" type="password" placeholder="Confirm Password" required>
                    <i class="fas fa-lock"></i>
                </div>
                
                <button type="submit" class="btn">Sign Up</button>
                
                <div class="create">
                    Already have an account? <a href="#" onclick="toggleForm(event)">Login</a>
                </div>
                
                <div class="social-login">
                    <div class="divider">
                        <span>Or sign up with</span>
                    </div>
                    <div class="social-icons">
                        <a href="#" class="fb"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="tw"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="gl"><i class="fab fa-google"></i></a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Message Container -->
<div id="auth-message" style="display: none;"></div>

{% block script %}

<script>
(function() {
    'use strict';
    
    // ========== Cookie Consent ==========
    window.acceptCookies = function() {
        try {
            localStorage.setItem('cookieConsent', 'accepted');
        } catch (e) {
            console.log('LocalStorage not available');
        }
        document.getElementById('cookieConsent').classList.remove('show');
    };
    
    window.declineCookies = function() {
        try {
            localStorage.setItem('cookieConsent', 'declined');
        } catch (e) {
            console.log('LocalStorage not available');
        }
        document.getElementById('cookieConsent').classList.remove('show');
        showMessage('You can still use the site, but some features may be limited.', 'info');
    };
    
    function checkCookieConsent() {
        try {
            const consent = localStorage.getItem('cookieConsent');
            if (!consent) {
                setTimeout(() => {
                    document.getElementById('cookieConsent').classList.add('show');
                }, 1000);
            }
        } catch (e) {
            // If localStorage is blocked, show consent banner
            setTimeout(() => {
                document.getElementById('cookieConsent').classList.add('show');
            }, 1000);
        }
    }
    
    // ========== Toggle Form Function ==========
    window.toggleForm = function(event) {
        event.preventDefault();
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        
        loginForm.classList.toggle('active');
        signupForm.classList.toggle('active');
    };

    // ========== Get Redirect Parameter ==========
    function getRedirectParameter() {
        const redirectInput = document.getElementById('redirect_to');
        if (redirectInput && redirectInput.value) {
            return redirectInput.value;
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('redirect') || '';
    }

    // ========== Login Handler ==========
    window.handleLogin = async function(event) {
        event.preventDefault();
        
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const redirectTo = getRedirectParameter();
        
        if (!email || !password) {
            showMessage('Please fill in all fields', 'error');
            return;
        }

        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Logging in...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    email: email,
                    password: password,
                    redirect_to: redirectTo
                })
            });
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server returned non-JSON response');
            }
            
            const data = await response.json();
            
            if (data.success) {
                showMessage(data.message, 'success');
                setTimeout(() => {
                    window.location.href = data.redirect;
                }, 500);
            } else {
                // Check if user needs to verify email
                if (data.redirect_to_verify) {
                    showMessage(data.message, 'error');
                    setTimeout(() => {
                        window.location.href = '/verify';
                    }, 2000);
                } else {
                    showMessage(data.message, 'error');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }
        } catch (error) {
            console.error('Login error:', error);
            showMessage('An error occurred. Please try again.', 'error');
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    };

    // ========== Signup Handler ==========
    window.handleSignup = async function(event) {
        event.preventDefault();
        
        const username = document.getElementById('signup-username').value;
        const email = document.getElementById('signup-email').value;
        const age = document.getElementById('signup-age').value;
        const gender = document.getElementById('signup-gender').value;
        const city = document.getElementById('signup-city').value;
        const password = document.getElementById('signup-password').value;
        const confirmPassword = document.getElementById('signup-confirm-password').value;
        
        if (!username || !email || !age || !gender || !city || !password || !confirmPassword) {
            showMessage('Please fill in all fields', 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            showMessage('Passwords do not match', 'error');
            return;
        }
        
        if (password.length < 6) {
            showMessage('Password must be at least 6 characters', 'error');
            return;
        }

        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Creating account...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch('/signup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    email: email,
                    age: parseInt(age),
                    gender: gender,
                    city: city,
                    password: password
                })
            });
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server returned non-JSON response');
            }
            
            const data = await response.json();
            
            if (data.success) {
                showMessage(data.message, 'success');
                setTimeout(() => {
                    window.location.href = '/verify';
                }, 1000);
            } else {
                showMessage(data.message, 'error');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        } catch (error) {
            console.error('Signup error:', error);
            showMessage('An error occurred. Please try again.', 'error');
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    };

    // ========== Show Message Function ==========
    function showMessage(message, type) {
        let messageEl = document.getElementById('auth-message');
        
        if (!messageEl) {
            messageEl = document.createElement('div');
            messageEl.id = 'auth-message';
            messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                font-weight: 600;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            document.body.appendChild(messageEl);
        }
        
        messageEl.textContent = message;
        
        if (type === 'success') {
            messageEl.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            messageEl.style.color = 'white';
        } else if (type === 'info') {
            messageEl.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
            messageEl.style.color = 'white';
        } else {
            messageEl.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
            messageEl.style.color = 'white';
        }
        
        messageEl.style.display = 'block';
        
        setTimeout(() => {
            messageEl.style.display = 'none';
        }, 4000);
    }

    // ========== Location Autocomplete ==========
    function initLocationAutocomplete() {
        const input = document.getElementById("signup-city");
        const suggestionsList = document.getElementById("suggestions");

        if (input && suggestionsList) {
            let debounceTimer;
            
            input.addEventListener("input", async () => {
                clearTimeout(debounceTimer);
                
                const query = input.value;
                if (query.length < 3) {
                    suggestionsList.innerHTML = "";
                    return;
                }

                debounceTimer = setTimeout(async () => {
                    try {
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`,
                            {
                                headers: {
                                    'User-Agent': 'AQI_Smart_Health_Advisor/1.0'
                                }
                            }
                        );
                        
                        if (!response.ok) {
                            return;
                        }
                        
                        const data = await response.json();
                        suggestionsList.innerHTML = "";

                        data.forEach(place => {
                            const li = document.createElement("li");
                            li.textContent = place.display_name;
                            li.onclick = () => {
                                input.value = place.display_name;
                                suggestionsList.innerHTML = "";
                            };
                            suggestionsList.appendChild(li);
                        });
                    } catch (error) {
                        console.error('Location search error:', error);
                    }
                }, 500);
            });
        }
    }

    // ========== Initialize on DOM Load ==========
    document.addEventListener('DOMContentLoaded', function() {
        // CRITICAL: Remove all flash message elements immediately
        const flashContainers = document.querySelectorAll('.flash-container, #flash-messages, .flash, .alert');
        flashContainers.forEach(el => {
            if (el) el.remove();
        });
        
        // Add ajax-page class to body to prevent flash messages
        document.body.classList.add('ajax-page');
        
        // Check cookie consent
        checkCookieConsent();
        
        const defaultForm = '{{ default_form }}';
        if (defaultForm === 'signup') {
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('signupForm').classList.add('active');
        }

        initLocationAutocomplete();

        const redirectParam = getRedirectParameter();
        if (redirectParam) {
            console.log('Redirect parameter:', redirectParam);
        }

        // Add CSS animation
        if (!document.getElementById('auth-styles')) {
            const style = document.createElement('style');
            style.id = 'auth-styles';
            style.textContent = `
                @keyframes slideInRight {
                    from {
                        opacity: 0;
                        transform: translateX(50px);
                    }
                    to {
                        opacity: 1;
                        transform: translateX(0);
                    }
                }
            `;
            document.head.appendChild(style);
        }
    });
})();
</script>

{% endblock %}

{% endblock %}