{% extends 'base.html' %}
{% block title %}Authentication{% endblock %}

{% block style %}
{{ super() }}

<!-- Override base.html flash messages for this page -->
<style>
    /* Hide all flash messages on login page - we use JavaScript messages */
    .flash-container {
        display: none !important;
    }
    
    #flash-messages {
        display: none !important;
    }
</style>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* Cookie Consent Banner */
.cookie-consent {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
    color: white;
    padding: 20px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
    z-index: 10000;
    display: none;
    animation: slideUp 0.5s ease-out;
}

.cookie-consent.show {
    display: block;
}

.cookie-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    flex-wrap: wrap;
}

.cookie-text {
    flex: 1;
    min-width: 250px;
}

.cookie-text h4 {
    margin: 0 0 8px 0;
    font-size: 18px;
    color: #fff;
}

.cookie-text p {
    margin: 0;
    font-size: 14px;
    color: #d1d5db;
    line-height: 1.5;
}

.cookie-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.cookie-btn {
    padding: 10px 24px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    font-family: 'Poppins', sans-serif;
}

.cookie-btn.accept {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.cookie-btn.accept:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.cookie-btn.decline {
    background: transparent;
    border: 2px solid #4b5563;
    color: #d1d5db;
}

.cookie-btn.decline:hover {
    border-color: #667eea;
    color: white;
}

@keyframes slideUp {
    from {
        transform: translateY(100%);
    }
    to {
        transform: translateY(0);
    }
}

@media (max-width: 768px) {
    .cookie-content {
        flex-direction: column;
        text-align: center;
    }
    
    .cookie-buttons {
        justify-content: center;
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div class="cookie-content">
        <div class="cookie-text">
            <h4>üç™ We Value Your Privacy</h4>
            <p>We use cookies and session storage to enhance your experience, keep you logged in, and analyze site usage. By clicking "Accept", you consent to our use of cookies.</p>
        </div>
        <div class="cookie-buttons">
            <button class="cookie-btn decline" onclick="declineCookies()">Decline</button>
            <button class="cookie-btn accept" onclick="acceptCookies()">Accept All</button>
        </div>
    </div>
</div>

<!-- Animated Background Particles -->
<div class="bg-particles">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
</div>

<div class="container">
    <!-- Logo Section -->
    <div class="logo-section">
        <div class="logo-icon">
            <img src="{{ url_for('static', filename='images/app_logo.png') }}" alt="AQI Logo" class="logo-image">
        </div>
        <div class="logo-text">AQI Smart Health Advisor</div>
    </div>

    <!-- Hidden input to store redirect parameter -->
    <input type="hidden" id="redirect_to" value="{{ redirect_to }}">

    <div class="form-box">
        <!-- Login Form -->
        <div class="form-container active" id="loginForm">
            <h2>Welcome Back</h2>
            <p class="form-subtitle">Sign in to monitor air quality and stay protected</p>
            
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="input-box">
                    <input id="login-email" name="email" type="email" placeholder="Email Address" required>
                    <i class="fas fa-envelope"></i>
                </div>
                
                <div class="input-box">
                    <input id="login-password" name="password" type="password" placeholder="Password" required>
                    <i class="fas fa-lock"></i>
                </div>
                
                <div class="remember">
                    <label>
                        <input type="checkbox" name="remember">
                        <span>Remember me</span>
                    </label>
                    <a href="#">Forgot password?</a>
                </div>
                
                <button type="submit" class="btn">Login</button>
                
                <div class="create">
                    Don't have an account? <a href="#" onclick="toggleForm(event)">Sign Up</a>
                </div>
                
                <div class="social-login">
                    <div class="divider">
                        <span>Or login with</span>
                    </div>
                    <div class="social-icons">
                        <a href="#" class="fb"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="tw"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="gl"><i class="fab fa-google"></i></a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Signup Form -->
        <div class="form-container" id="signupForm">
            <h2>Create Account</h2>
            <p class="form-subtitle">Join us to start monitoring air quality</p>
            
            <form id="signup-form" onsubmit="handleSignup(event)">
                <div class="input-box">
                    <input id="signup-username" name="username" type="text" placeholder="Full Name" required>
                    <i class="fas fa-user"></i>
                </div>
                
                <div class="input-box">
                    <input id="signup-email" name="email" type="email" placeholder="Email" required>
                    <i class="fas fa-envelope"></i>
                </div>
                
                <div class="input-box">
                    <input id="signup-age" name="age" type="number" placeholder="Age" min="1" max="150" required>
                    <i class="fas fa-calendar-alt"></i>
                </div>
                
                <div class="input-box">
                    <select id="signup-gender" name="gender" required>
                        <option value="" disabled selected>Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                    <i class="fas fa-venus-mars"></i>
                </div>
                
                <div class="input-box">
                    <input type="text" id="signup-city" name="city" placeholder="Enter city" autocomplete="off" required>
                    <i class="fas fa-map-marker-alt"></i>
                    <ul id="suggestions"></ul>
                </div>
                
                <div class="input-box">
                    <input id="signup-password" name="password" type="password" placeholder="Password" minlength="6" required>
                    <i class="fas fa-lock"></i>
                </div>
                
                <div class="input-box">
                    <input id="signup-confirm-password" name="confirm_password" type="password" placeholder="Confirm Password" required>
                    <i class="fas fa-lock"></i>
                </div>
                
                <button type="submit" class="btn">Sign Up</button>
                
                <div class="create">
                    Already have an account? <a href="#" onclick="toggleForm(event)">Login</a>
                </div>
                
                <div class="social-login">
                    <div class="divider">
                        <span>Or sign up with</span>
                    </div>
                    <div class="social-icons">
                        <a href="#" class="fb"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="tw"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="gl"><i class="fab fa-google"></i></a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Message Container -->
<div id="auth-message" style="display: none;"></div>

{% endblock %}

{% block script %}
    <!-- Load base scripts (MessageManager from base.html) -->
    {{ super() }}

    <!-- Load CookieSessionManager ONLY if not already loaded -->
    <script>
        if (typeof CookieSessionManager === 'undefined') {
            const script = document.createElement('script');
            script.src = "{{ url_for('static', filename='js/cookiesSessionManager.js') }}";
            script.async = false;
            document.head.appendChild(script);
        }
    </script>

    <!-- Page-specific functionality wrapped in IIFE -->
    <script>
        (function() {
            'use strict';
            
            console.log('üîê Login page loaded');
            
            // Check MessageManager availability
            if (typeof MessageManager !== 'undefined') {
                console.log('‚úÖ MessageManager available');
            } else {
                console.warn('‚ö†Ô∏è MessageManager not loaded');
            }
            
            // ========== Cookie Consent Functions ==========
            window.acceptCookies = function() {
                if (typeof CookieSessionManager !== 'undefined') {
                    CookieSessionManager.acceptCookies();
                } else {
                    // Fallback
                    try {
                        localStorage.setItem('cookieConsent', 'accepted');
                    } catch (e) {
                        console.log('LocalStorage not available');
                    }
                }
                const banner = document.getElementById('cookieConsent');
                if (banner) {
                    banner.classList.remove('show');
                }
            };
            
            window.declineCookies = function() {
                if (typeof CookieSessionManager !== 'undefined') {
                    CookieSessionManager.declineCookies();
                } else {
                    try {
                        localStorage.setItem('cookieConsent', 'declined');
                    } catch (e) {
                        console.log('LocalStorage not available');
                    }
                }
                const banner = document.getElementById('cookieConsent');
                if (banner) {
                    banner.classList.remove('show');
                }
                
                if (typeof MessageManager !== 'undefined') {
                    MessageManager.show('You can still use the site, but some features may be limited.', 'info');
                }
            };
            
            function checkCookieConsent() {
                let consent = null;
                
                if (typeof CookieSessionManager !== 'undefined') {
                    consent = CookieSessionManager.getCookie('cookieConsent');
                } else {
                    try {
                        consent = localStorage.getItem('cookieConsent');
                    } catch (e) {
                        // LocalStorage blocked
                    }
                }
                
                if (!consent) {
                    setTimeout(() => {
                        const banner = document.getElementById('cookieConsent');
                        if (banner) {
                            banner.classList.add('show');
                        }
                    }, 1000);
                }
            }
            
            // ========== Toggle Form Function ==========
            window.toggleForm = function(event) {
                event.preventDefault();
                const loginForm = document.getElementById('loginForm');
                const signupForm = document.getElementById('signupForm');
                
                if (loginForm && signupForm) {
                    loginForm.classList.toggle('active');
                    signupForm.classList.toggle('active');
                }
            };

            // ========== Get Redirect Parameter ==========
            function getRedirectParameter() {
                const redirectInput = document.getElementById('redirect_to');
                if (redirectInput && redirectInput.value) {
                    return redirectInput.value;
                }
                
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('redirect') || '';
            }

            // ========== Login Handler ==========
            window.handleLogin = async function(event) {
                event.preventDefault();
                
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const redirectTo = getRedirectParameter();
                
                if (!email || !password) {
                    if (typeof MessageManager !== 'undefined') {
                        MessageManager.show('Please fill in all fields', 'warning');
                    }
                    return;
                }

                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Logging in...';
                submitBtn.disabled = true;
                
                try {
                    const response = await fetch('/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            email: email,
                            password: password,
                            redirect_to: redirectTo
                        })
                    });
                    
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('Server returned non-JSON response');
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        if (typeof MessageManager !== 'undefined') {
                            MessageManager.show(data.message || 'Login successful!', 'success');
                        }
                        
                        // ‚úÖ FIX: Safe session save with Unicode handling
                        if (typeof CookieSessionManager !== 'undefined' && data.user) {
                            try {
                                // Convert user data to JSON and handle Unicode properly
                                const userDataStr = JSON.stringify(data.user);
                                
                                // Use encodeURIComponent instead of btoa for Unicode safety
                                const encodedData = encodeURIComponent(userDataStr);
                                CookieSessionManager.setCookie('user_session', encodedData, 7);
                                
                                console.log('‚úÖ Session saved successfully');
                            } catch (saveError) {
                                console.error('‚ö†Ô∏è Session save error:', saveError);
                                // Continue anyway - server session is still valid
                            }
                        }
                        
                        setTimeout(() => {
                            window.location.href = data.redirect;
                        }, 500);
                    } else {
                        if (data.redirect_to_verify) {
                            if (typeof MessageManager !== 'undefined') {
                                MessageManager.show(data.message, 'error');
                            }
                            setTimeout(() => {
                                window.location.href = '/verify';
                            }, 2000);
                        } else {
                            if (typeof MessageManager !== 'undefined') {
                                MessageManager.show(data.message, 'error');
                            }
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    if (typeof MessageManager !== 'undefined') {
                        MessageManager.show('An error occurred. Please try again.', 'error');
                    }
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            };

            // ========== Signup Handler ==========
            window.handleSignup = async function(event) {
                event.preventDefault();
                
                const username = document.getElementById('signup-username').value;
                const email = document.getElementById('signup-email').value;
                const age = document.getElementById('signup-age').value;
                const gender = document.getElementById('signup-gender').value;
                const city = document.getElementById('signup-city').value;
                const password = document.getElementById('signup-password').value;
                const confirmPassword = document.getElementById('signup-confirm-password').value;
                
                if (!username || !email || !age || !gender || !city || !password || !confirmPassword) {
                    if (typeof MessageManager !== 'undefined') {
                        MessageManager.show('Please fill in all fields', 'warning');
                    }
                    return;
                }
                
                if (password !== confirmPassword) {
                    if (typeof MessageManager !== 'undefined') {
                        MessageManager.show('Passwords do not match', 'error');
                    }
                    return;
                }
                
                if (password.length < 6) {
                    if (typeof MessageManager !== 'undefined') {
                        MessageManager.show('Password must be at least 6 characters', 'warning');
                    }
                    return;
                }

                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Creating account...';
                submitBtn.disabled = true;
                
                try {
                    const response = await fetch('/signup', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            username: username,
                            email: email,
                            age: parseInt(age),
                            gender: gender,
                            city: city,
                            password: password
                        })
                    });
                    
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('Server returned non-JSON response');
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        if (typeof MessageManager !== 'undefined') {
                            MessageManager.show(data.message || 'Account created successfully!', 'success');
                        }
                        setTimeout(() => {
                            window.location.href = '/verify';
                        }, 1000);
                    } else {
                        if (typeof MessageManager !== 'undefined') {
                            MessageManager.show(data.message, 'error');
                        }
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('Signup error:', error);
                    if (typeof MessageManager !== 'undefined') {
                        MessageManager.show('An error occurred. Please try again.', 'error');
                    }
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            };

            // ========== Location Autocomplete ==========
            function initLocationAutocomplete() {
                const input = document.getElementById("signup-city");
                const suggestionsList = document.getElementById("suggestions");

                if (input && suggestionsList) {
                    let debounceTimer;
                    
                    input.addEventListener("input", async () => {
                        clearTimeout(debounceTimer);
                        
                        const query = input.value;
                        if (query.length < 3) {
                            suggestionsList.innerHTML = "";
                            return;
                        }

                        debounceTimer = setTimeout(async () => {
                            try {
                                const response = await fetch(
                                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`,
                                    {
                                        headers: {
                                            'User-Agent': 'AQI_Smart_Health_Advisor/1.0'
                                        }
                                    }
                                );
                                
                                if (!response.ok) {
                                    return;
                                }
                                
                                const data = await response.json();
                                suggestionsList.innerHTML = "";

                                data.forEach(place => {
                                    const li = document.createElement("li");
                                    li.textContent = place.display_name;
                                    li.onclick = () => {
                                        input.value = place.display_name;
                                        suggestionsList.innerHTML = "";
                                    };
                                    suggestionsList.appendChild(li);
                                });
                            } catch (error) {
                                console.error('Location search error:', error);
                            }
                        }, 500);
                    });
                }
            }

            // ========== Initialize on DOM Load ==========
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üîê Login page loaded');
                
                // Check if MessageManager is available
                if (typeof MessageManager !== 'undefined') {
                    console.log('‚úÖ MessageManager available');
                    // Process any existing Flask messages
                    MessageManager.processFlaskMessages();
                } else {
                    console.warn('‚ö†Ô∏è MessageManager not loaded');
                }
                
                // Check if CookieSessionManager is available
                if (typeof CookieSessionManager !== 'undefined') {
                    console.log('‚úÖ CookieSessionManager available');
                }
                
                // Check cookie consent
                checkCookieConsent();
                
                const defaultForm = '{{ default_form }}';
                if (defaultForm === 'signup') {
                    const loginForm = document.getElementById('loginForm');
                    const signupForm = document.getElementById('signupForm');
                    if (loginForm && signupForm) {
                        loginForm.classList.remove('active');
                        signupForm.classList.add('active');
                    }
                }

                initLocationAutocomplete();

                const redirectParam = getRedirectParameter();
                if (redirectParam) {
                    console.log('üîó Redirect parameter:', redirectParam);
                }
            });
        })();
    </script>

{% endblock %}