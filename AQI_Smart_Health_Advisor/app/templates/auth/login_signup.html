{% extends 'base.html' %}
{% block title %}Authentication - AQI Smart Health Advisor{% endblock %}

{% block style %}
{{ super() }}

<style>
    /* Hide all flash messages on login page - we use JavaScript messages */
    .flash-container {
        display: none !important;
    }
    
    #flash-messages {
        display: none !important;
    }
</style>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}" />
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
{% endblock %}

{% block content %}

<div class="cookie-consent" id="cookieConsent">
    <div class="cookie-content">
        <div class="cookie-text">
            <h4><i class="fas fa-cookie-bite"></i> We Value Your Privacy</h4>
            <p>We use cookies and session storage to enhance your experience, keep you logged in, and analyze site usage. By clicking "Accept", you consent to our use of cookies.</p>
        </div>
        <div class="cookie-buttons">
            <button class="cookie-btn decline" onclick="declineCookies()">Decline</button>
            <button class="cookie-btn accept" onclick="acceptCookies()">Accept All</button>
        </div>
    </div>
</div>

<div class="main-wrapper">
    <a href="{{ url_for('home_auth.aqi_homepage') }}" class="back-home-btn">
        <i class="fas fa-arrow-left"></i> Back to Home
    </a>

    <div class="container">
        <div class="card-header-strip"></div>

        <div class="logo-section">
            <div class="logo-icon">
                <img src="{{ url_for('static', filename='images/app_logo.png') }}" alt="AQI Logo" class="logo-image">
            </div>
            <div class="logo-text">AQI Smart Health Advisor</div>
        </div>

        <input type="hidden" id="redirect_to" value="{{ redirect_to }}">

        <div class="form-box">
            <div class="form-container active" id="loginForm">
                <h2>Welcome Back</h2>
                <p class="form-subtitle">Sign in to monitor air quality and stay protected</p>
                
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="input-box">
                        <input id="login-email" name="email" type="email" placeholder="Email Address" required>
                        <i class="fas fa-envelope"></i>
                    </div>
                    
                    <div class="input-box">
                        <input id="login-password" name="password" type="password" placeholder="Password" required>
                        <i class="fas fa-lock"></i>
                    </div>
                    
                    <div class="remember">
                        <label>
                            <input type="checkbox" name="remember">
                            <span>Remember me</span>
                        </label>
                        <a href="#">Forgot password?</a>
                    </div>
                    
                    <button type="submit" class="btn">Login</button>
                    
                    <div class="create">
                        Don't have an account? <a href="#" onclick="toggleForm(event)">Sign Up</a>
                    </div>
                    
                    <div class="social-login">
                        <div class="divider">
                            <span>Or login with</span>
                        </div>
                        <div class="social-icons">
                            <a href="#" class="social-btn"><i class="fab fa-facebook-f"></i></a>
                            <a href="#" class="social-btn"><i class="fab fa-twitter"></i></a>
                            <a href="#" class="social-btn"><i class="fab fa-google"></i></a>
                        </div>
                    </div>
                </form>
            </div>

            <div class="form-container" id="signupForm">
                <h2>Create Account</h2>
                <p class="form-subtitle">Join us to start monitoring air quality</p>
                
                <form id="signup-form" onsubmit="handleSignup(event)">
                    <div class="input-box">
                        <input id="signup-username" name="username" type="text" placeholder="Full Name" required>
                        <i class="fas fa-user"></i>
                    </div>
                    
                    <div class="input-box">
                        <input id="signup-email" name="email" type="email" placeholder="Email" required>
                        <i class="fas fa-envelope"></i>
                    </div>
                    
                    <div class="input-box">
                        <input id="signup-age" name="age" type="number" placeholder="Age" min="1" max="150" required>
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    
                    <div class="input-box">
                        <select id="signup-gender" name="gender" required>
                            <option value="" disabled selected>Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                        <i class="fas fa-venus-mars"></i>
                    </div>
                    
                    <div class="input-box">
                        <input type="text" id="signup-city" name="city" placeholder="Enter city" autocomplete="off" required>
                        <i class="fas fa-map-marker-alt"></i>
                        <ul id="suggestions"></ul>
                    </div>
                    
                    <div class="input-box">
                        <input id="signup-password" name="password" type="password" placeholder="Password" minlength="6" required>
                        <i class="fas fa-lock"></i>
                    </div>
                    
                    <div class="input-box">
                        <input id="signup-confirm-password" name="confirm_password" type="password" placeholder="Confirm Password" required>
                        <i class="fas fa-lock"></i>
                    </div>
                    
                    <button type="submit" class="btn">Sign Up</button>
                    
                    <div class="create">
                        Already have an account? <a href="#" onclick="toggleForm(event)">Login</a>
                    </div>
                    
                    <div class="social-login">
                        <div class="divider">
                            <span>Or sign up with</span>
                        </div>
                        <div class="social-icons">
                            <a href="#" class="social-btn"><i class="fab fa-facebook-f"></i></a>
                            <a href="#" class="social-btn"><i class="fab fa-twitter"></i></a>
                            <a href="#" class="social-btn"><i class="fab fa-google"></i></a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="auth-message" style="display: none;"></div>

{% endblock %}

{% block script %}
    {{ super() }}

    <script>
        if (typeof CookieSessionManager === 'undefined') {
            const script = document.createElement('script');
            script.src = "{{ url_for('static', filename='js/cookiesSessionManager.js') }}";
            script.async = false;
            document.head.appendChild(script);
        }
    </script>

    <script>
        (function() {
            'use strict';
            
            console.log('ðŸ” Login page loaded');
            
            // Check MessageManager availability
            if (typeof MessageManager !== 'undefined') {
                console.log('âœ… MessageManager available');
            } else {
                console.warn('âš ï¸ MessageManager not loaded');
            }
            
            // ========== Cookie Consent Functions ==========
            window.acceptCookies = function() {
                if (typeof CookieSessionManager !== 'undefined') {
                    CookieSessionManager.handleAccept();
                } else {
                    try { localStorage.setItem('cookieConsent', 'accepted'); } catch (e) {}
                    const banner = document.getElementById('cookieConsent');
                    if (banner) {
                        banner.classList.remove('show');
                        setTimeout(() => banner.style.display = 'none', 500);
                    }
                }
            };
            
            window.declineCookies = function() {
                if (typeof CookieSessionManager !== 'undefined') {
                    CookieSessionManager.handleDecline();
                } else {
                    try { localStorage.setItem('cookieConsent', 'declined'); } catch (e) {}
                    const banner = document.getElementById('cookieConsent');
                    if (banner) {
                        banner.classList.remove('show');
                        setTimeout(() => banner.style.display = 'none', 500);
                    }
                    if (typeof MessageManager !== 'undefined') {
                        MessageManager.show('You can still use the site, but some features may be limited.', 'info');
                    }
                }
            };
            
            function checkCookieConsent() {
                let consent = null;
                if (typeof CookieSessionManager !== 'undefined') {
                    consent = CookieSessionManager.getCookie('cookieConsent');
                } else {
                    try { consent = localStorage.getItem('cookieConsent'); } catch (e) {}
                }
                
                if (!consent) {
                    setTimeout(() => {
                        const banner = document.getElementById('cookieConsent');
                        if (banner) banner.classList.add('show');
                    }, 1000);
                }
            }
            
            // ========== Toggle Form Function ==========
            window.toggleForm = function(event) {
                event.preventDefault();
                const loginForm = document.getElementById('loginForm');
                const signupForm = document.getElementById('signupForm');
                
                if (loginForm && signupForm) {
                    loginForm.classList.toggle('active');
                    signupForm.classList.toggle('active');
                }
            };

            // ========== Get Redirect Parameter ==========
            function getRedirectParameter() {
                const redirectInput = document.getElementById('redirect_to');
                if (redirectInput && redirectInput.value) {
                    return redirectInput.value;
                }
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('redirect') || '';
            }

            // ========== Login Handler ==========
            window.handleLogin = async function(event) {
                event.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const redirectTo = getRedirectParameter();
                
                if (!email || !password) {
                    if (typeof MessageManager !== 'undefined') MessageManager.show('Please fill in all fields', 'warning');
                    return;
                }

                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Logging in...';
                submitBtn.disabled = true;
                
                try {
                    const response = await fetch('/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ email: email, password: password, redirect_to: redirectTo })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        if (typeof MessageManager !== 'undefined') MessageManager.show(data.message || 'Login successful!', 'success');
                        
                        if (typeof CookieSessionManager !== 'undefined' && data.user) {
                            try {
                                const encodedData = encodeURIComponent(JSON.stringify(data.user));
                                CookieSessionManager.setCookie('user_session', encodedData, 7);
                            } catch (saveError) { console.error('âš ï¸ Session save error:', saveError); }
                        }
                        
                        setTimeout(() => { window.location.href = data.redirect; }, 500);
                    } else {
                        if (data.redirect_to_verify) {
                            if (typeof MessageManager !== 'undefined') MessageManager.show(data.message, 'error');
                            setTimeout(() => { window.location.href = '/verify'; }, 2000);
                        } else {
                            if (typeof MessageManager !== 'undefined') MessageManager.show(data.message, 'error');
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    if (typeof MessageManager !== 'undefined') MessageManager.show('An error occurred. Please try again.', 'error');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            };

            // ========== Signup Handler ==========
            window.handleSignup = async function(event) {
                event.preventDefault();
                const username = document.getElementById('signup-username').value;
                const email = document.getElementById('signup-email').value;
                const age = document.getElementById('signup-age').value;
                const gender = document.getElementById('signup-gender').value;
                const city = document.getElementById('signup-city').value;
                const password = document.getElementById('signup-password').value;
                const confirmPassword = document.getElementById('signup-confirm-password').value;
                
                if (!username || !email || !age || !gender || !city || !password || !confirmPassword) {
                    if (typeof MessageManager !== 'undefined') MessageManager.show('Please fill in all fields', 'warning');
                    return;
                }
                
                if (password !== confirmPassword) {
                    if (typeof MessageManager !== 'undefined') MessageManager.show('Passwords do not match', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    if (typeof MessageManager !== 'undefined') MessageManager.show('Password must be at least 6 characters', 'warning');
                    return;
                }

                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Creating account...';
                submitBtn.disabled = true;
                
                try {
                    const response = await fetch('/signup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        body: JSON.stringify({ username: username, email: email, age: parseInt(age), gender: gender, city: city, password: password })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        if (typeof MessageManager !== 'undefined') MessageManager.show(data.message || 'Account created successfully!', 'success');
                        setTimeout(() => { window.location.href = '/verify'; }, 1000);
                    } else {
                        if (typeof MessageManager !== 'undefined') MessageManager.show(data.message, 'error');
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('Signup error:', error);
                    if (typeof MessageManager !== 'undefined') MessageManager.show('An error occurred. Please try again.', 'error');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            };

            // ========== Location Autocomplete ==========
            function initLocationAutocomplete() {
                const input = document.getElementById("signup-city");
                const suggestionsList = document.getElementById("suggestions");

                if (input && suggestionsList) {
                    let debounceTimer;
                    input.addEventListener("input", async () => {
                        clearTimeout(debounceTimer);
                        const query = input.value.trim();
                        if (query.length < 3) {
                            suggestionsList.innerHTML = "";
                            return;
                        }

                        debounceTimer = setTimeout(async () => {
                            try {
                                const response = await fetch(`/api/location/search?q=${encodeURIComponent(query)}`, { method: 'GET', headers: { 'Accept': 'application/json' } });
                                if (!response.ok) return;
                                const data = await response.json();
                                suggestionsList.innerHTML = "";

                                if (data.results && data.results.length > 0) {
                                    data.results.forEach(place => {
                                        const li = document.createElement("li");
                                        li.textContent = place.display_name;
                                        li.onclick = () => { input.value = place.display_name; suggestionsList.innerHTML = ""; };
                                        suggestionsList.appendChild(li);
                                    });
                                } else {
                                    const li = document.createElement("li");
                                    li.textContent = "No locations found";
                                    li.style.color = "#999";
                                    li.style.cursor = "default";
                                    suggestionsList.appendChild(li);
                                }
                            } catch (error) { console.error('Location search error:', error); }
                        }, 500);
                    });
                }
            }

            // ========== Initialize on DOM Load ==========
            document.addEventListener('DOMContentLoaded', function() {
                if (typeof MessageManager !== 'undefined') MessageManager.processFlaskMessages();
                checkCookieConsent();
                
                const defaultForm = '{{ default_form }}';
                if (defaultForm === 'signup') {
                    const loginForm = document.getElementById('loginForm');
                    const signupForm = document.getElementById('signupForm');
                    if (loginForm && signupForm) {
                        loginForm.classList.remove('active');
                        signupForm.classList.add('active');
                    }
                }
                initLocationAutocomplete();
            });
        })();
    </script>
{% endblock %}