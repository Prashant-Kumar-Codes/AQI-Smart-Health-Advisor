{% extends 'base.html' %}
{% block title %}Verify OTP - AQI Smart Health Advisor{% endblock %}

{% block style %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/verify.css') }}">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}

{% block content %}
<!-- Animated Background Particles -->
<div class="bg-particles">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
</div>

<div class="container">
    <div class="verify-content">
        <!-- Logo Section -->
        <div class="logo-section">
            <div class="logo-icon">üõ°Ô∏è</div>
            <div class="logo-text">AQI Smart Health Advisor</div>
        </div>

        <div class="verify-box">
            <div class="verify-header">
                <div class="verify-icon">
                    <i class="fas fa-envelope-open"></i>
                </div>
                <h2 class="verify-title">Verify Your Email</h2>
                <p class="verify-subtitle">Enter the 6-digit code sent to your email</p>
            </div>

            <form id="verifyForm" method="POST" action="{{ url_for('login_auth.verify') }}">
                <div class="otp-input-container">
                    <input 
                        type="text" 
                        id="otpInput"
                        name="otp" 
                        maxlength="6" 
                        inputmode="numeric"
                        placeholder="‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢" 
                        class="single-otp-input" 
                        required
                        pattern="[0-9]{6}"
                        title="Please enter 6 digits"
                        autocomplete="off"
                    >
                    <div class="otp-hint">
                        <i class="fas fa-info-circle"></i>
                        <span>Check your email inbox and spam folder</span>
                    </div>
                </div>

                <div class="timer-section" id="timerSection">
                    <i class="fas fa-clock"></i>
                    <span id="timerText">Code expires in: </span>
                    <span id="countdown" class="countdown-number">60</span>
                    <span id="timerUnit">s</span>
                </div>

                <button id="verify-btn" type="submit" class="verify-btn">
                    <i class="fas fa-check-circle"></i>
                    <span>Verify OTP</span>
                </button>
            </form>

            <div class="divider">
                <span>Didn't receive code?</span>
            </div>

            <form id="resendForm" method="POST" action="{{ url_for('login_auth.resend_otp') }}">
                <button id="resend-btn" type="submit" class="resend-btn" disabled>
                    <i class="fas fa-redo-alt"></i>
                    <span id="resendText">Resend OTP</span>
                </button>
            </form>

            <div class="back-login">
                <a href="{{ url_for('login_auth.login_signup_page') }}">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to Login</span>
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // ============================================
    // TIMER & OTP VERIFICATION SCRIPT
    // ============================================

    console.log('üîê OTP Verification System Initialized');

    // Get elements
    const countdown = document.getElementById('countdown');
    const timerSection = document.getElementById('timerSection');
    const timerText = document.getElementById('timerText');
    const timerUnit = document.getElementById('timerUnit');
    const resendBtn = document.getElementById('resend-btn');
    const resendText = document.getElementById('resendText');
    const otpInput = document.getElementById('otpInput');
    const verifyForm = document.getElementById('verifyForm');
    const resendForm = document.getElementById('resendForm');

    // Get initial time from server (in seconds)
    let timeLeft = parseInt("{{ remaining|default(60) }}") || 60;
    let timerInterval = null;

    console.log('‚è±Ô∏è Initial time remaining:', timeLeft, 'seconds');

    /**
     * Format time display (MM:SS or SS)
     */
    function formatTime(seconds) {
        if (seconds >= 60) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        return seconds.toString();
    }

    /**
     * Update timer display
     */
    function updateTimerDisplay() {
        if (timeLeft > 0) {
            countdown.textContent = formatTime(timeLeft);
            timerUnit.textContent = timeLeft >= 60 ? '' : 's';
        } else {
            countdown.textContent = 'Expired';
            timerUnit.textContent = '';
            timerText.textContent = 'Code ';
            timerSection.classList.add('expired');
        }
    }

    /**
     * Start countdown timer
     */
    function startTimer() {
        console.log('‚ñ∂Ô∏è Starting timer...');
        
        // Clear any existing timer
        if (timerInterval) {
            clearInterval(timerInterval);
        }

        // Reset UI
        timerSection.classList.remove('expired');
        timerText.textContent = 'Code expires in: ';
        resendBtn.disabled = true;
        resendBtn.classList.add('disabled');
        resendText.textContent = 'Resend OTP';

        // Update display immediately
        updateTimerDisplay();

        // Start countdown
        timerInterval = setInterval(() => {
            timeLeft--;
            console.log('‚è≥ Time remaining:', timeLeft);
            updateTimerDisplay();

            if (timeLeft <= 0) {
                console.log('‚è∞ Timer expired!');
                clearInterval(timerInterval);
                timerInterval = null;
                
                // Enable resend button
                resendBtn.disabled = false;
                resendBtn.classList.remove('disabled');
                resendText.innerHTML = '<i class="fas fa-redo-alt"></i> Resend OTP';
                
                // Show notification
                showNotification('OTP has expired. Please request a new code.', 'warning');
            }
        }, 1000);
    }

    /**
     * Show notification
     */
    function showNotification(message, type = 'info') {
        // You can implement a toast notification here
        console.log(`üì¢ ${type.toUpperCase()}: ${message}`);
    }

    /**
     * Auto-format OTP input - only allow digits
     */
    otpInput.addEventListener('input', (e) => {
        // Remove any non-digit characters
        let value = e.target.value.replace(/\D/g, '');
        
        // Limit to 6 digits
        value = value.slice(0, 6);
        
        e.target.value = value;

        // Auto-submit when 6 digits entered (optional)
        if (value.length === 6) {
            console.log('‚úÖ Full OTP entered:', value);
            // Uncomment to auto-submit:
            // verifyForm.submit();
        }
    });

    /**
     * Prevent paste of non-numeric content
     */
    otpInput.addEventListener('paste', (e) => {
        e.preventDefault();
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        const numericText = pastedText.replace(/\D/g, '').slice(0, 6);
        otpInput.value = numericText;
        
        if (numericText.length === 6) {
            console.log('üìã OTP pasted:', numericText);
        }
    });

    /**
     * Validate OTP on form submit
     */
    verifyForm.addEventListener('submit', (e) => {
        const otp = otpInput.value.trim();
        
        if (otp.length !== 6) {
            e.preventDefault();
            
            // Show error state
            otpInput.classList.add('error');
            otpInput.focus();
            
            showNotification('Please enter a valid 6-digit OTP', 'error');
            
            // Remove error state after 2 seconds
            setTimeout(() => {
                otpInput.classList.remove('error');
            }, 2000);
            
            return false;
        }

        if (timeLeft <= 0) {
            e.preventDefault();
            showNotification('OTP has expired. Please request a new code.', 'error');
            return false;
        }

        console.log('üì§ Submitting OTP:', otp);
        // Form will submit normally
    });

    /**
     * Handle resend OTP
     */
    resendForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        if (resendBtn.disabled) {
            console.log('‚è∏Ô∏è Resend blocked - timer still running');
            return false;
        }

        console.log('üîÑ Resending OTP...');
        
        // Disable button immediately
        resendBtn.disabled = true;
        resendText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
        
        // Reset timer
        timeLeft = 60;
        
        // Submit form via fetch to handle response
        fetch(resendForm.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => {
            console.log('üì¨ Resend response received');
            
            // Start new timer
            startTimer();
            
            // Clear OTP input
            otpInput.value = '';
            otpInput.focus();
            
            showNotification('New OTP sent! Check your email.', 'success');
            
            // Reload page to get updated flash messages
            window.location.reload();
        })
        .catch(error => {
            console.error('‚ùå Resend error:', error);
            resendBtn.disabled = false;
            resendText.textContent = 'Resend OTP';
            showNotification('Failed to resend OTP. Please try again.', 'error');
        });
    });

    /**
     * Focus on OTP input when page loads
     */
    window.addEventListener('load', () => {
        otpInput.focus();
    });

    /**
     * Handle visibility change (pause/resume timer when tab is hidden)
     */
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            console.log('üëÅÔ∏è Tab hidden - timer continues in background');
        } else {
            console.log('üëÅÔ∏è Tab visible - timer running');
        }
    });

    // ============================================
    // INITIALIZE TIMER
    // ============================================
    
    console.log('üöÄ Initializing timer with', timeLeft, 'seconds remaining');
    
    if (timeLeft > 0) {
        startTimer();
    } else {
        console.log('‚ö†Ô∏è OTP already expired on page load');
        updateTimerDisplay();
        resendBtn.disabled = false;
        resendBtn.classList.remove('disabled');
    }

    // Log session info
    console.log('üìß Email session active');
    console.log('‚è∞ OTP expires at:', new Date(Date.now() + timeLeft * 1000).toLocaleTimeString());
</script>
{% endblock %}